<!DOCTYPE HTML>
<html>
<head>
	<title>PinnerSpace Home</title>
	<link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="../bootstrap/css/bootstrap-theme.min.css">
	<script src="../scripts/jquery-1.11.1.min.js" type="text/javascript"></script>
	<script src="../bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
	<script src="../scripts/fabric.js" type="text/javascript"></script>
	<script src="../scripts/jscolor/jscolor.js" type="text/javascript"></script>
	<!--Google Login Script-->
	<script type="text/javascript">
	(function() {
		var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
		po.src = 'https://apis.google.com/js/client:plusone.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
	})();
	</script>
	<!--End of Google Login Script-->
	<!--Canvas Script--> <!--Maybe should move to another file? When it's more or less done?-->
	<script type = "text/javascript">
	var canvas;
	var bgcolor = 'FFFFFF';
	var blkcolor = '000000';
	function loadCanvas(board){
		canvas = new fabric.Canvas('canvas');
		canvas.loadFromJSON(board);
		//canvas.on('object:moving', onObjectMoving);
		canvas.on('object:scaling', onObjectScaling);
		//canvas.on('object:rotating', onObjectMoving);
    	canvas.on('object:modified', onObjectMoving);
    	canvas.on('after:render', onObjectMoving);
	}
	function saveCanvas(){
		$.post("/saveBoard", { 
			boardUser: "{{ currBoard.boardUser }}",
			boardID: {{ currBoard.boardID }},
			data: JSON.stringify(canvas)
		});
		alert("Successfully saved!");
	}
	//INCOMPLETE
	function revert(board){
		var resp=confirm("You sure? All your unsaved work will be lost...<STILL EMPTY>");
		if (resp==true){
  			// Need to reload with curr JSON data not the one just passed through
  		}

	}
	function clearCanvas(){
		var resp=confirm("You sure? This will clear everything!");
		if (resp==true){
  			canvas.clear();
  		}
	}
	function addBlock(){
		var center = canvas.getCenter();
		var rect = new fabric.Rect({
			left: center.left,
			top: center.top,
			width: 30,
			height: 30,
			minScaleLimit: 1,
			fill: blkcolor,
		})
		canvas.add(rect);
	}
	function delBlock(){
		var curr = canvas.getActiveObject();
		canvas.remove(curr);
	}
	function setBG(){
		canvas.setBackgroundColor(bgcolor, canvas.renderAll.bind(canvas));
	}
	// Code to set limit to boundaries //
    function onObjectMoving(e){
        var selectedObject = e.target;
        if(!selectedObject) return;
        var updateCoords = false,
            coords = selectedObject.getBoundingRect(),
            maxWidth = canvas.getWidth(),
            maxHeight = canvas.getHeight();


        //if the object overflow to the right/bottom reposition it
        if((coords.width+coords.left)>maxWidth){
            updateCoords = true;
            var newLeft = (coords.width/2) + (maxWidth - coords.width)-10;
            selectedObject.set({left: newLeft});
        }
        if((coords.height+coords.top)>maxHeight){
            updateCoords = true;
            var newTop = (coords.height/2) + (maxHeight - coords.height)-10;
            selectedObject.set({top: newTop});
        }

        //if the object is moved "AWAY" on the left/top of the canvas reposition it
        if(coords.left<0){
            updateCoords = true;
            selectedObject.set({left: (coords.width/2)});
        }
        if(coords.top<0){
            updateCoords = true;
            selectedObject.set({top: (coords.height/2)});
        }

        if(updateCoords){
            selectedObject.setCoords();
        }
    }

	function onObjectScaling(e){
        var shape = e.target;
        if(!shape) return;
        var cWidth = canvas.getWidth(),
            cHeight = canvas.getHeight(),
            currLeft = shape.left,
            currTop = shape.top,
            actualWidth = shape.scaleX * shape.width,
            actualHeight = shape.scaleY * shape.height;

        // if scaling extends beyond right/bottom
        if(actualWidth+currLeft>cWidth){
            shape.set({scaleX:(cWidth-currLeft)/shape.width});
        }
        if(actualHeight+currTop>cHeight){
            shape.set({scaleY:(cHeight-currTop)/shape.height});
        }

        // if scaling extends beyond left/top
        if(actualWidth+currLeft<0){
            shape.set({scaleX:-(currLeft)/shape.width});
        }
        if(actualHeight+currTop<0){
            shape.set({scaleY:-(currTop)/shape.height});
        }
    }
	</script>
	<!--End of Canvas Script-->
</head>
<body onload="loadCanvas({{boardData}})">
	<!--HEADER-->
	<div id="header">
		<div class="jumbotron">
			<h2 class="title" style="text-align: center">PinnerSpace</h2>
			
			<ul class="nav nav-pills pull-left clearfix">
				<li><a href="./">Home</a></li>
				<li><a href="./boards">Boards</a></li>
				<li><a href="./settings">Settings</a></li>
			</ul>
			<ul class="nav nav-pills pull-right"> <!--class="span4 offset8 signin-align"-->
				<li class="disabled"><a>Welcome back <b>{{ user_nick }}</b>!</a></li>
				<li><a href="{{ logout }}">Logout</a></li>
			</ul>
		</div>
	</div>
	
	<!--BOARD NAME/SELECTOR-->
	<div id="boardInfo" align="center">
		Board{{ currBoard.boardID }} {{ currBoard.boardUser }}
	</div>
	<center>
		<div class="btn-group">
			<button class="disabled btn btn-primary">{{ currBoard.boardName }}</button>
			{% if user.numBoards > 0 or user.following > 0 %}
			<button data-toggle="dropdown" class="btn btn-primary dropdown-toggle"><span class="caret"></span></button>
			<ul class="dropdown-menu">
				{% for board in boards %}
					{% if board.boardID != currBoard.boardID or board.boardUser != currBoard.boardUser %}
					<li><a href="./board?boardID={{ board.boardID }}&boardUser={{ board.boardUser }}">{{ board.boardName }}</a></li>
					{% endif %}
				{% endfor %}
				<li class="divider"></li>
				{% for board2 in boards2 %}
					{% if board2.boardID != currBoard.boardID or board2.boardUser != currBoard.boardUser %}
					<li><a href="./board?boardID={{ board2.boardID }}&boardUser={{ board2.boardUser }}">{{ board2.boardName }}</a></li>
					{% endif %}
				{% endfor %}
			</ul>
			{% endif %}
		</div>
	</center>

	<!--PinBoard-->
	<div id="pinboard" style="width:1000px; height:500px; margin: 0 auto; padding: 5px">
		<!--canvas id must be consistent with js script-->
		<canvas id="canvas" width="1000" height="500" style="border: 1px solid black;">
			This text is displayed if your browser does not support HTML5 Canvas.
		</canvas>
	</div>

	<!--Modifiers-->
	<div align="center" style="padding: 5px">
		<p>
		<button class="btn" value="addblock" type="submit" onclick="addBlock()" float="center">New Block</button>
		<button class="btn" value="delblock" type="submit" onclick="delBlock()" float="center">Delete Block</button>
		<button class="btn" value="clear" type="submit" onclick="clearCanvas()" float="center">Clear Board</button>
		</p>
		<p>
		<button class="btn" value="save" type="submit" onclick="saveCanvas()" float="center">Save Changes</button>
		<button class="btn" value="revert" type="submit" onclick="revert({{boardData}})" float="center">Reset Changes</button>
		</p>
		<p>
			Change background colour:
			<input class="color {pickerFaceColor:'#DBDBDB'}" onchange="bgcolor='#'+this.color.toString().toUpperCase()">
			<input type="submit" value="Apply" onclick="setBG()">
		</p>
		<p>
			Change block colour:
			<input class="color {pickerFaceColor:'#DBDBDB'}" onchange="blkcolor='#'+this.color.toString().toUpperCase()">
			<input type="submit" value="New Block" onclick="addBlock()">
			<!--CONSIDER making it an apply thing? either change default or change selected block-->
		</p>
	</div>
	<!--END BODY-->
</body>
</html>


<!--Old stuff
		var canvas = new fabric.Canvas('canvas');
		canvas.backgroundColor = 'green';
		var rect = new fabric.Rect({
			left: 100,
			top: 100,
			fill: 'black',
			width: 20,
			height: 20
		});

		// "add" rectangle onto canvas
		canvas.add(rect);

		var canvasStr = JSON.stringify(canvas);
		console.log(canvasStr);

alert('Please enter a value!');
input.focus(); // focuses on the blank to fill (didn't know that)
-->