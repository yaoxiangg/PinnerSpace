<!DOCTYPE HTML>
<html>
<head>
	<title>PinnerSpace Home</title>
	<link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="../bootstrap/css/bootstrap-theme.min.css">
	<script src="../scripts/jquery-1.11.1.min.js" type="text/javascript"></script>
	<script src="../bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
	<script src="../scripts/fabric.js" type="text/javascript"></script>
	<script src="../scripts/jscolor/jscolor.js" type="text/javascript"></script>
	<!--Google Login Script-->
	<script type="text/javascript">
	(function() {
		var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
		po.src = 'https://apis.google.com/js/client:plusone.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
	})();
	</script>
	<!--End of Google Login Script-->
	<!--Canvas Script--> <!--Maybe should move to another file? When it's more or less done?-->
	<script type = "text/javascript">
	var canvas;
	var bgcolor = '#FFFFFF';
	var blkcolor = '#000000',
		blkcolor2 = '#000000';
	var orig;
	var atLimit;
	var lastSave;
	function loadCanvas(board, init){
		if(init){
			canvas = new fabric.Canvas('canvas');
			canvas.on({
				'object:modified': checkOOB,
				'object:selected': saveOrig,
				'object:scaling': setLimit,
			});
			lastSave = board;
		}
		canvas.loadFromJSON(board);
		canvas.forEachObject(function(o){
			o.set({
				minScaleLimit: 1,
				borderColor: 'rgba(67,46,79,0.75)',
				cornerColor: 'rgba(58,174,175,0.85)',
				cornerSize: 9,
				transparentCorners: false,
			});
		});
	}
	function saveCanvas(){
		$.post("/saveBoard", {
			boardUser: "{{ currBoard.boardUser }}",
			boardID: {{ currBoard.boardID }},
			data: JSON.stringify(canvas)
		});
		lastSave = JSON.stringify(canvas);
		alert("Successfully saved!");
	}
	function revert(){
		var resp=confirm("You sure? All your unsaved work will be lost...");
		if (resp==true){
  			loadCanvas(lastSave, false);
  		}
  	}
  	function clearCanvas(){
  		var resp=confirm("Are you sure? This will clear everything!");
  		if (resp){
  			canvas.clear();
  		}
  	}
  	function addBlock(){
  		var center = canvas.getCenter();
  		var rect = new fabric.Rect({
  			left: center.left,
  			top: center.top,
  			width: 10,
  			height: 10,
  			scaleX: 3,
  			scaleY: 3,
  			minScaleLimit: 1,
  			borderColor: 'rgba(67,46,79,0.75)',
  			cornerColor: 'rgba(58,174,175,0.85)',
  			cornerSize: 9,
			transparentCorners: false, // border/corner info not saved
			fill: blkcolor,
		})
  		canvas.add(rect);
  	}
  	function cloneBlock(){
  		var curr = canvas.getActiveObject();
  		var clone = fabric.util.object.clone(curr);
  		clone.center();
  		curr.set('active', false);
  		canvas.add(clone);
  	}
  	function delActive() {
  		var currGrp = canvas.getActiveGroup();
  		var curr = canvas.getActiveObject();
		if(currGrp){
			currGrp.forEachObject(function(o){ canvas.remove(o) });
			canvas.discardActiveGroup().renderAll();
		} else if(curr){
			canvas.remove(canvas.getActiveObject());
		}
  	}
	function setBG() { canvas.setBackgroundColor(bgcolor, canvas.renderAll.bind(canvas)); }
	function setBlkColor() {
		canvas.getActiveObject().setFill(blkcolor2);
		canvas.renderAll();
	}

  	// text
  	function addText() {
  		var input = "";
  		alert('Please enter a value!');
		input.focus(); // focuses on the blank to fill
  	}

	// Code to set limit to boundaries //
	function saveOrig(e) { orig = fabric.util.object.clone(e.target); }
	function setLimit(e){
		var curr=e.target;
		curr.setCoords();
		var bounds = curr.getBoundingRect(),
			maxWidth = canvas.getWidth(),
			maxHeight = canvas.getHeight();
		var outOf = {
			top: bounds.top<0,
			left: bounds.left<0,
			bottom: bounds.top+bounds.height>maxHeight,
			right: bounds.left+bounds.width>maxWidth,
		};

		// if not out of bounds, save state
		// (the interval is not very fast, so this method is not so precise if you move fast)
		if(!((outOf.top || outOf.left) || (outOf.bottom || outOf.right))){
			atLimit = {
				top: curr.getTop(),
				left: curr.getLeft(),
				scaleX: curr.getScaleX(),
				scaleY: curr.getScaleY(),
			};
		}
	}
	function checkOOB(e){
		var curr = e.target;
		if(!curr) return;
		// if scale has been modified, checkScale for OOB
		if((orig.getScaleX() != curr.getScaleX()) || (orig.getScaleY() != curr.getScaleY()))
			checkScale(curr);
		// otherwise check position
		else
			checkPos(curr);
		// save new state into orig
		orig = fabric.util.object.clone(curr);
	}
	function checkScale(curr){
		var updateCoords = false,
			bounds = curr.getBoundingRect(),
			maxWidth = canvas.getWidth(),
			maxHeight = canvas.getHeight(),
			currAngle = curr.angle%360;
		var outOf = {
			top: bounds.top<0,
			left: bounds.left<0,
			bottom: bounds.top+bounds.height>maxHeight,
			right: bounds.left+bounds.width>maxWidth,
		};
		// if out of bounds, reset to last "atLimit" state
		if((outOf.top || outOf.left) || (outOf.bottom || outOf.right)){
			curr.set(atLimit);
			curr.setCoords();
			// console.log("New curr: " + JSON.stringify(curr));
		}
	}
	function checkPos(curr){
		var updateCoords = false,
		bounds = curr.getBoundingRect(),
		maxWidth = canvas.getWidth(),
		maxHeight = canvas.getHeight(),
		currAngle = curr.angle%360;
		var outOf = {
			top: bounds.top<0,
			left: bounds.left<0,
			bottom: bounds.top+bounds.height>maxHeight,
			right: bounds.left+bounds.width>maxWidth,
		};
		// Exceed Right
		if(outOf.right){
			updateCoords = true;
			if(currAngle>0 && currAngle<90){
				curr.set({left: maxWidth-Math.ceil(Math.cos(currAngle*Math.PI/180)*curr.width*curr.scaleX)});
			}else if(currAngle>=90 && currAngle<=180){
				curr.set({left: maxWidth});
			}else if(currAngle>180 && currAngle<270){
				curr.set({left: maxWidth-Math.ceil(Math.cos((270-currAngle)*Math.PI/180)*curr.height*curr.scaleY)});
			}else{
				curr.set({left: maxWidth-bounds.width});
			}
		}
		// Exceed Bottom
		if(outOf.bottom){
			updateCoords = true;
			if(currAngle>=0 && currAngle<=90){
				curr.set({top: maxHeight-bounds.height});
			}else if(currAngle>90 && currAngle<180){
				curr.set({top: maxHeight-Math.ceil(Math.cos((currAngle-90)*Math.PI/180)*curr.width*curr.scaleX)});
			}else if(currAngle>=180 && currAngle<=270){
				curr.set({top: maxHeight});
			}else{
				curr.set({top: maxHeight-Math.ceil(Math.cos((360-currAngle)*Math.PI/180)*curr.height*curr.scaleY)});
			}
		}
		// Exceed Left
		if(outOf.left){
			updateCoords = true;
			if(currAngle>0 && currAngle<90){
				curr.set({left: Math.ceil(Math.cos((90-currAngle)*Math.PI/180)*curr.height*curr.scaleY)});
			}else if(currAngle>=90 && currAngle<=180){
				curr.set({left: bounds.width});
			}else if(currAngle>180 && currAngle<270){
				curr.set({left: Math.ceil(Math.cos((currAngle-180)*Math.PI/180)*curr.width*curr.scaleX)});
			}else{
				curr.set({left: 0});
			}
		}
		// Exceed Top
		if(outOf.top){
			updateCoords = true;
			if(currAngle>=0 && currAngle<90){
				curr.set({top: 0});
			}else if(currAngle>=90 && currAngle<180){
				curr.set({top: Math.ceil(Math.cos((180-currAngle)*Math.PI/180)*curr.height*curr.scaleY)});
			}else if(currAngle>=180 && currAngle<270){
				curr.set({top: bounds.height});
			}else{
				curr.set({top: Math.ceil( Math.cos( (currAngle-270) * Math.PI/180) * curr.width * curr.scaleX )});
			}
		}

		// Implement new coordinates
		if(updateCoords){
			curr.setCoords();
		}
	}
	</script>
	<!--End of Canvas Script-->
</head>
<body onload="loadCanvas({{boardData}}, true)">
	<!--HEADER-->
	<div id="header">
		<div class="jumbotron">
			<h2 class="title" style="text-align: center">PinnerSpace</h2>
			
			<ul class="nav nav-pills pull-left clearfix">
				<li><a href="./">Home</a></li>
				<li><a href="./boards">Boards</a></li>
				<li><a href="./settings">Settings</a></li>
			</ul>
			<ul class="nav nav-pills pull-right"> <!--class="span4 offset8 signin-align"-->
				<li class="disabled"><a>Welcome back <b>{{ user_nick }}</b>!</a></li>
				<li><a href="/logout">Logout</a></li>
			</ul>
		</div>
	</div>
	
	<!--BOARD NAME/SELECTOR-->
	<div id="boardInfo" align="center">
		Board{{ currBoard.boardID }} {{ currBoard.boardUser }}
	</div>
	<center>
		<div class="btn-group">
			<button class="disabled btn btn-primary">{{ currBoard.boardName }}</button>
			{% if user.numBoards > 0 or user.following > 0 %}
			<button data-toggle="dropdown" class="btn btn-primary dropdown-toggle"><span class="caret"></span></button>
			<ul class="dropdown-menu">
				{% for board in boards %}
				{% if board.boardID != currBoard.boardID or board.boardUser != currBoard.boardUser %}
				<li><a href="./board?boardID={{ board.boardID }}&boardUser={{ board.boardUser }}">{{ board.boardName }}</a></li>
				{% endif %}
				{% endfor %}
				<li class="divider"></li>
				{% for board2 in boards2 %}
				{% if board2.boardID != currBoard.boardID or board2.boardUser != currBoard.boardUser %}
				<li><a href="./board?boardID={{ board2.boardID }}&boardUser={{ board2.boardUser }}">{{ board2.boardName }}</a></li>
				{% endif %}
				{% endfor %}
			</ul>
			{% endif %}
		</div>
	</center>

	<!--PinBoard-->
	<div id="pinboard" style="width:1000px; height:500px; margin: 0 auto; padding: 5px">
		<!--canvas id must be consistent with js script-->
		<canvas id="canvas" width="1000" height="500" style="border: 1px solid black;">
			This text is displayed if your browser does not support HTML5 Canvas.
		</canvas>
	</div>

	<!--TO BE FILLED-->
	{% if user.email in currBoard.boardEditor %}
	<!--Show set of buttons exclusive to board editors-->
	{% elif user.email in currBoard.boardPoster %}
	<!--Show set of buttons exclusive to board posters-->
	{% else %}
	<!--Show set of buttons exclusive to board viewers-->
	{% endif %}

	<!--Modifiers-->
	<div align="center" style="padding: 5px">
		<p>
			<button class="btn" value="addblock" type="submit" onclick="addBlock()" float="center">New Block</button>
			<button class="btn" value="delblock" type="submit" onclick="delActive()" float="center">Delete</button>
			<button class="btn" value="cloneblock" type="submit" onclick="cloneBlock()" float="center">Clone Block</button>
			<button class="btn" value="clear" type="submit" onclick="clearCanvas()" float="center">Clear Board</button>
		</p>
		<p>
			<button class="btn" value="save" type="submit" onclick="saveCanvas()" float="center">Save Changes</button>
			<button class="btn" value="revert" type="submit" onclick="revert()" float="center">Reset Changes</button>
		</p>
		<p>
			Change background colour:
			<input class="color {pickerFaceColor:'#DBDBDB'}" onchange="bgcolor='#'+this.color.toString().toUpperCase()">
			<input type="submit" value="Apply" onclick="setBG()">
		</p>
		<p>
			Change new block colour:
			<input class="color {pickerFaceColor:'#DBDBDB'}" onchange="blkcolor='#'+this.color.toString().toUpperCase()">
			<input type="submit" value="New Block" onclick="addBlock()">
		</p>
		<p>
			Change current block colour:
			<input class="color {pickerFaceColor:'#DBDBDB'}" onchange="blkcolor2='#'+this.color.toString().toUpperCase()">
			<input type="submit" value="Apply" onclick="setBlkColor()">
			<!--CONSIDER making it an apply thing? either change default or change selected block-->
		</p>
	</div>
	<!--END BODY-->
</body>
</html>