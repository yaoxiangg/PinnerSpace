<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>PinnerSpace Home</title>
	<link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="../bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="../scripts/colpick/css/colpick.css" type="text/css">
	<style>
	/*body {
		background-image: url("../images/galacticmetropolis3.png");
	}*/
	.jumbotron {
		background-image: url("../images/space1.jpg");
	}
	#pinnerspace {
		font-family: "Trebuchet MS", Helvetica, sans-serif;
		font-size: 3em;
		color:white;
	}
	#wb {
		color:white;
	}
	#wb-logout, #nav-menu {
		background-color: rgba(0,0,0,0.2);
	}
	#pinboard {
  		border-style: ridge;
  		border-width: 10px;
  		border-color: #E7CAA4;
  	}

	table.center {
    	margin-left:auto; 
    	margin-right:auto;
  	}
  	table td { 
  		display: table-cell;
  		vertical-align: top; 
	}
	#imagebox, #bgimgbox {
    	display:none;
    	width:800px;
    	border:8px solid #666;
    	/* for modern browsers use semi-transparent color on the border. nice! */
    	border:8px solid rgba(82, 82, 82, 0.698);
    	/* hot CSS3 features for mozilla and webkit-based browsers (rounded borders) */
    	-moz-border-radius:5px;
   		-webkit-border-radius:5px;
	}

  	#imagebox div, #bgimgbox div {
    	border:1px solid #3B5998;
    	background-color:#fff;
  	}
  	#noPreview, #bgnoPreview {
  		display:none;
  	}

  	#bgimageurl.placeholder {
    	text-align: center;
  	}

  	#selectableBG .ui-selecting { background: #FECA40; }
 	#selectableBG .ui-selected { background: #F39814; color: white; }
 	#selectableBG { padding-left: 80px; width: 800px; list-style-type: none;}
  	#selectableBG li { padding: 1px; width: 200px; height: 140px; line-height: 135px; text-align: center; display: inline-block; vertical-align: middle;}

  	#infotable td {
  		padding:2px;
  		border-spacing:5px;
  	}
  	#newobjtable td {
  		padding:2px;
  	}
  	#myTab, #myTabContent , #editinglocked, #boardButtons, #exitButton, #itext-controls{
  		display: none;
  	}

	.color-box {
		display: inline-block;
		vertical-align: bottom;
		width:22px;
		height:22px;
		margin:0px;
		border: 1px solid gray;
	}

  	input[type=range] {
  		width: 50px;
  		display: inline-table;
  		vertical-align: middle;
  	}

  	#btnSwitchBoard {
  		float: right;
  	}
  	</style>
</head>
<body onload="init()">
	<!--************************* HEADER *************************-->
	<div id="header">
		<div class="jumbotron">
			<h2 id="pinnerspace" class="title" style="text-align: center">PinnerSpace</h2>
			
			<ul id="nav-menu" class="nav nav-pills pull-left clearfix">
				<li><a href="./"><b>Home</b></a></li>
				<li><a href="./boards"><b>Boards</b></a></li>
				<li><a href="./settings"><b>Settings</b></a></li>
			</ul>
			<ul id="wb-logout" class="nav nav-pills pull-right">
				<li class="disabled"><a id="wb">Welcome back <b>{{ user_nick }}</b>!</a></li>
				<li><a href="/logout"><b>Logout</b></a></li>
			</ul>
		</div>
	</div>
	
	<!--************************* BODY *************************-->
	<table class="center">
		<tr>
			<!--************************* LEFT: Pinboard *************************-->
			<td>
				<div id="boardInfo" align="center">
					You are currently viewing <strong>{{ currBoard.boardName }}</strong>
				</div>
				<div id="pinboard" style="width: 920px; height:620px; margin: 0 auto;">
					<!--canvas id must be consistent with js script-->
					<canvas id="canvas" width="900" height="600">
						This text is displayed if your browser does not support HTML5 Canvas.
					</canvas>
				</div>

				<div id="btnSwitchBoard" class="btn-group dropup">
					<button class="disabled btn btn-primary">View another board</button>
					{% if user.numBoards > 0 or user.following > 0 %}
					<button data-toggle="dropdown" class="btn btn-primary dropdown-toggle"><span class="caret"></span></button>
					<ul class="dropdown-menu">
						{% for board in boards %}
						{% if board.boardID != currBoard.boardID or board.boardUser != currBoard.boardUser %}
						<li><a href="./board?boardID={{ board.boardID }}&boardUser={{ board.boardUser }}">{{ board.boardName }}</a></li>
						{% endif %}
						{% endfor %}
						<li class="divider"></li>
						{% for board2 in boards2 %}
						{% if board2.boardID != currBoard.boardID or board2.boardUser != currBoard.boardUser %}
						<li><a href="./board?boardID={{ board2.boardID }}&boardUser={{ board2.boardUser }}">{{ board2.boardName }}</a></li>
						{% endif %}
						{% endfor %}
					</ul>
					{% endif %}
				</div>
			</td>

			<!--************************* RIGHT: Info++ *************************-->
			<td id="rightside" width="1px" style="padding:10px">
				<!--************************* BOARD NAME/SELECTOR *************************-->
				<p></p>

				<!--TO BE FILLED-->
				{% if user.email == currBoard.boardUser or user.email in currBoard.boardEditor %}
				<!--EDIT BUTTON-->
				<div id="toolBoxButton"><button class="btn btn-primary" onclick="showToolBox()">Edit</button></div>
				<div id="editinglocked">Someone else is editing. Please try again later.</div>

				{% elif user.email == currBoard.boardUser or user.email in currBoard.boardPoster %}
				<!--EDIT BUTTON-->
				<div id="toolBoxButton"><button class="btn btn-primary" onclick="showToolBox()">Edit</button></div>
				<div id="editinglocked">Someone else is editing. Please try again later.</div>
				

				{% else %}
				<!--Show set of buttons exclusive to board viewers-->
				{% endif %}

				<div id="exitButton">
					<span id="toolBoxExitButton"><button type="button" class="btn btn-primary" onclick="location.reload(true)">Save and Exit</button></span>
					{% if user.email == currBoard.boardUser %}
					<form name="input" action="./boardSettings" method="post" width="100%" style="display:inline">
						<button name="boardID" type="submit" class="btn btn-primary" width="100%" value={{ currBoard.boardID }}>Board Settings</button>
					</form>
					{% endif %}
					<hr>
				</div>
				
				<!--************************* TABS *************************-->
				<ul id="myTab" class="nav nav-pills">
					<li class="active"><a href="#new" data-toggle="tab">New Object</a></li>
					<li id="currObjTab"><a href="#modifycurrent" data-toggle="tab">Current Object</a></li>
					<li><a href="#modifycanvas" data-toggle="tab">Background</a></li>
				</ul>
				<hr>
				<div id="myTabContent" class="tab-content">
					<!--************************* New Objects *************************-->
					<div class="tab-pane fade in active" id="new">
						<table id="newobjtable">
							<tr><strong>Properties:</strong></tr>
							<tr><p></tr>
							<tr>
								<td align="right">Object Colour:</td>
								<td><span class="color-box" id="newblkcol" /></td>
							</tr>
							<tr>
								<td align="right">Text Colour:</td>
								<td><span class="color-box" id="newtextcolor" /></td>
							</tr>
							<tr>
								<td align="right">Text(optional):</td>
								<td><textarea id="newtext" maxlength="255" rows="3" placeholder="<insert text>"></textarea></td>
							</tr>
						</table>
						<p></p>
						<p id="newobjbuttons">
							<strong>Create a new</strong>
							<p></p>
							<span class="btn-group">
								<button type="button" class="btn btn-default" id="addblock" onclick="addBlock()">Block</button>
								<button type="button" class="btn btn-default" id="addtext" onclick="addText()">Textbox</button>
								<button type="button" class="btn btn-default" id="addpostit" onclick="addPostIt()">Post-It</button>
								<button type="button" class="btn btn-default" id="addimage" onclick="imageBox()">Image</button>
							</span>
						</p>
						<div id="imagebox" style="position: fixed;">
							<div align="center">
								<p class="close">x</p>
								<h2>Insert Picture</h2>
								<input type="text" id="imageurl" onblur="preloadImage()" size="35" placeholder="<Image Url>">
								<button onclick="addImage()">Add it!</button>
								<hr>
								<center><p id="noPreview">No preview available</p>
								<img id="imageHolder" src="" width="780px"></img></center>
								<p></p>
							</div>
						</div>
					</div>
					<!--************************* Current Object *************************-->
					<div class="tab-pane fade" id="modifycurrent">
						<div id="toolBox1">
							<strong>Object Controls:</strong>
							<p></p>
							<div class="btn-group">
								<button type="button" class="btn btn-default" onclick="delActive()">Delete</button>
								<button type="button" class="btn btn-default" onclick="cloneActive()">Clone</button>
								<div class="btn-group">
									<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"> Position
										<span class="caret"></span>
									</button>
									<ul class="dropdown-menu" role="menu">
										<li><a href="" onclick="canvas.getActiveObject().bringForward(); return false;">Bring Forward</a></li>
										<li><a href="" onclick="canvas.getActiveObject().sendBackwards(); return false;">Send Backwards</a></li>
									</ul>
								</div>
							</div>
							<span id="breakgrpbtn" hidden="true"><button type="button" class="btn btn-default" onclick="breakActiveGrp()">Break Group</button> </span>
							<p></p>
						</div>
						<div id="toolBox2" hidden>
							<strong>Group Controls:</strong>
							<p></p>
							<div class="btn-group">
								<button type="button" class="btn btn-default" onclick="delActive()">Delete</button>
								<button type="button" class="btn btn-default" onclick="cloneActive()">Clone</button>
							</div>
							<button class="btn btn-default" onclick="groupActive()">Group</button>
							<p></p>
						</div>
						<div id="infotablep">
							<table id="infotable">
								<tr id="infotable1a"> <!--to hide when it is i-text-->
									<td> Height: </td><td> <input type="text" id="infoH" style="width:50px;" maxlength="6" onchange="updateFromWin(this)"> </td>
									<td> Width: </td><td> <input type="text" id="infoW" style="width:50px;" maxlength="6" onchange="updateFromWin(this)"> </td>
									<td id="infoFill"> Fill: </td><td id="infoFillB"> <span class="color-box" id="fillColor" /> </td>
								</tr>
								<tr id="infotable1b">
									<td> X: </td><td> <input type="text" id="infoX" style="width:50px;" maxlength="6" onchange="updateFromWin(this)"> </td>
									<td> Y: </td><td> <input type="text" id="infoY" style="width:50px;" maxlength="6" onchange="updateFromWin(this)"> </td>
									<td> Angle: </td><td> <input type="text" id="infoAng" style="width:50px;" maxlength="6" onchange="updateFromWin(this)"></td>
								</tr>
							</table>
						</div>
						<p></p>
						<!--ITEXT CONTROLS-->
						<div id="itext-controls">
							<strong> Text Controls: </strong>
							<p></p>
							<div>
								<span class="btn-group">
									<!--Not sure what the ng-class should do and whether it works-->
									<button class="btn-sm btn btn-default"><del><span class="color-box" id="textColor" /></span></del></button>
									<button type="button" class="btn btn-default" onclick="setActiveStyle('fontWeight', getActiveStyle('fontWeight') === 'bold' ? '' : 'bold');" ng-class="{'btn-inverse': isBold()}"><b>B</b></button>
									<button type="button" class="btn btn-default" id="text-cmd-italic" onclick="setActiveStyle('fontStyle', getActiveStyle('fontStyle') === 'italic' ? '' : 'italic');" ng-class="{'btn-inverse': isItalic()}"><i>I</i></button>
									<button type="button" class="btn btn-default" id="text-cmd-underline" onclick="toggleUnderline()" ng-class="{'btn-inverse': isUnderline()}"><u>U</u></button>
									<button type="button" class="btn btn-default" id="text-cmd-linethrough" onclick="toggleLinethrough()" ng-class="{'btn-inverse': isLinethrough()}"><del>S</del></button>
								</span>
								<span>
									<select id="fontFamily" name="fontFamily">
										<option value="arial" selected="">Arial</option>
										<option value="comic sans ms">Comic Sans MS</option>
										<option value="consolas">Consolas</option>
										<option value="courier">Courier</option>
										<option value="georgia">Georgia</option>
										<option value="helvetica">Helvetica</option>
										<option value="impact">Impact</option>
										<option value="lucida console">Lucida Console</option>
										<option value="myriad pro">Myriad Pro</option>
										<option value="segoe ui">Segoe UI</option>
										<option value="tahoma">Tahoma</option>
										<option value="times new roman">Times New Roman</option>
										<option value="verdana">Verdana</option>
									</select>
								</span>
							</div>
							<p></p>
							<div>
								Font Size:
								<input type="range" value="20" min="20" max="120" step="1" id="fontSize"  onchange="setActiveStyle(id, this.value)">
								Align:
								<select id="textAlign" name="textAlign">
									<option value="left">Left</option>
									<option value="center">Center</option>
									<option value="right">Right</option>
									<option value="justify">Justify</option>
								</select>
							</div>
							<p></p>
							<div>
								<span id="changePostitColor">
								PostIt Color:
								<span class="color-box" id="backgroundColor" />
								</span>
								Highlight:
								<span class="color-box" id="textBackgroundColor"/>
							</div>
							<p></p>
							<div>
								Stroke (Width/Color):
								<input type="range" value="0" min="0" max="5" id="strokeWidth" onchange="setActiveStyle(id, parseInt(this.value,10))">
								<span class="color-box" id="stroke" />
							</div>
						</div>
						<!--END ITEXT CONTROLS-->
						<p></p>
					</div>
					<!--************************* Modify Canvas *************************-->
					<div class="tab-pane fade" id="modifycanvas">
					<p>
						Background Colour:
						<span class="color-box" id="canvasBGCol" />
						<p class="bgimgbutton">
							<button class="btn btn-default" onclick="bgimgBox()">Background Image</button>
						</p>
						<div id="bgimgbox" style="position: fixed;">
							<div>
								<p class="close">x</p>
								<center><h2>Background</h2></center>
								<ul id="selectableBG">
									<li class="ui-state-default"><img height="120" width="180" src="../images/bg1.jpg"></img></li>
									<li class="ui-state-default"><img height="120" width="180" src="../images/bg2.jpg"></img></li>
									<li class="ui-state-default"><img height="120" width="180" src="../images/bg3.jpg"></img></li>
									<li class="ui-state-default"><img height="120" width="180" src="../images/bg4.jpg"></img></li>
									<li class="ui-state-default"><img height="120" width="180" src="../images/bg5.jpg"></img></li>
									<li class="ui-state-default"><img height="120" width="180" id="bgimageHolder" src="../images/bg6.jpg"></img></li>
								</ul>
								<center>
								<p><input type="text" id="bgimageurl" onblur="bgpreloadImage()" size="35" placeholder="Custom Background Image Url"></p>
								<button class="btn btn-default" onclick="changeBGImg()">Change Background</button>
								<hr>
								<p id="bgnoPreview">No preview available<p>
								</center>
							</div>
						</div>
					</p>
					</div>
				</div>
				<div id="boardButtons">
				<p>
					<button class="btn btn-success" onclick="saveCanvas(true)">Save</button>
					<button class="btn btn-warning" onclick="revert()">Reset Canvas</button>
					<button class="btn btn-danger" onclick="clearCanvas()">Clear Board</button>
				</p>
				</div>
			</td>
			<!--END OF RIGHT COLUMN-->
		</tr>
	</table>
	<!--END BODY-->
	<script src="../scripts/jquery-1.11.1.min.js" type="text/javascript"></script>
	<script src="../bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
	<script src="../scripts/fabric.min.js" type="text/javascript"></script>
	<script src="../scripts/jquery.tools.min.js" type="text/javascript"></script>
	<script src="../scripts/jquery-ui-1.10.4.custom.min.js" type="text/javascript"></script>
	<script src="../scripts/tinycolor.js" type="text/javascript"></script>
	<script src="../scripts/colpick/js/colpick.js" type="text/javascript"></script>
	<!--Canvas Script--> <!--Maybe should move to another file? When it's more or less done?-->
	<script type = "text/javascript">

	/************************ PAGE INITIALISATION *************************/
	$(function(){
		$("#fontFamily").change(function() {
			setActiveProp("fontFamily", $("#fontFamily").val());
		});
		$("#textAlign").change(function() {
			setActiveProp('textAlign', $("#textAlign").val());
		});
	});

	if (window.location.href.indexOf('#_=_') > 0) {
    	window.location = window.location.href.replace(/#.*/, '');
	}

	/************************ GLOBAL VARIABLES *************************/
	var canvas;
	var bgselected;				// Image ID setter for background
	var fntcolor = '#000000';	// Colour setter for new text
	var blkcolor = '#FFFFFF';	// Colour setter for new block
	var orig;					// Holds last selected/modified object (for clone)
	var atLimit;				// Holds last acceptable position
	var lastSave;				// Holds last save state (for load/revert)
	var isSaved;				// Counter for whether changes have been made
	var idleTime = 0;			// Counter for number of minutes user is idle
	var idleInterval;			// Holds ID for setInterval() idle timer (for reset)
	
	/************************ BOARD INITIALISATION *************************/
	function init(){
		// Initialise imagebox for addImage()
		$("#imagebox").overlay({
			mask: {
				color: '#fff',
				loadSpeed: 200,
				opacity: 0.5
			},
			closeOnClick: false,
		});
		// Initialise imagebox for backgrounds
   		$("#bgimgbox").overlay({
			mask: {
				color: '#fff',
				loadSpeed: 200,
   				opacity: 0.5
    		},
    		closeOnClick: false,
   		});
   		// Initialise...this thing.
   		$( "#selectableBG").selectable();

		// Initialise Canvas
		canvas = new fabric.StaticCanvas('canvas');

		// Retrive board data from server and load canvas
		$.ajax({
			url: 'getBoardData',
			data: {
				boardUser: "{{ currBoard.boardUser }}",
				boardID: {{ currBoard.boardID }}
			},
			type: "GET",
			//async: false
		}).done(function( data ) {
			lastSave = data; // Save server data locally
			loadCanvas();
		});
		var editor = "{{ currBoard.boardEditor }}";
		var poster = "{{ currBoard.boardPoster }}";
		if ("{{ user.email }}" == "{{ currBoard.boardUser }}" || editor.indexOf("{{ user.email }}") > -1 || poster.indexOf("{{ user.email }}") > -1) {
			document.getElementById("rightside").width = "375";
		}
	}
	function showToolBox() {
		// Check if anyone is editing, reject edit request if so
		$.post("/getEditor", { 
			user: "{{ currBoard.boardUser }}",
			boardID: {{ currBoard.boardID }},
			boardEditor: "{{ user.email }}"
		}).done(function( data ) {
				if (data == "") {
					$("#exitButton").effect("fade", "", 500, "");
					$("#boardButtons").effect("fade", "", 500, "");
					$("#myTab").effect("fade", "", 500, "");
					$("#myTabContent").effect("fade", "", 500, "");
					document.getElementById("editinglocked").style.display = "none";
    				document.getElementById("toolBoxButton").style.display = "none";
    				startIdleListener();
    				initEdit();
					return;
				}
				$("#editinglocked").effect("fade", "", 500, "");
		});
	}
	function initEdit(){
		// Reinitialise board using data from server (ensures it's updated)
		$.ajax({
			url: 'getBoardData',
			data: {
				boardUser: "{{ currBoard.boardUser }}",
				boardID: {{ currBoard.boardID }}
			},
			type: "GET",
			async: false
		}).done(function( data ) {
			// Save server data locally
			lastSave = data;
			// Clear static canvas and load interactive canvas
			canvas.dispose();
			canvas = new fabric.Canvas('canvas');
			loadCanvas();
		});
		
		// Add edit-mode functionalities
		canvas.on({
			'object:modified': checkOOB,
			'object:selected': objSelected,
			'object:scaling': setLimit,
			'object:rotating': setLimit,
			'selection:cleared': resetInfoWin,
		});
		$(document).on('keydown', function(e){	// Ctrl+S functionality
			if(e.ctrlKey && e.which === 83){	// Check for the Ctrl key being pressed, and if the key = [S] (83)
				saveCanvas(true);
				e.preventDefault();
			}
		});
		window.onbeforeunload = function(e){	// Page-leave functionality
			if(!isSaved)
				saveCanvas(false);
			timedOut(false);
		};
		// Initial load auxiliary function(s)
		resetInfoWin();
		promptBoardEmpty();
		initColPickers();
	}
	function promptBoardEmpty() {
		var data = jQuery.parseJSON(lastSave);
		if(data.objects == ""){
			var input = document.getElementById("newblkcol");
			alert("It appears your board is empty.\nPerhaps you would like to start by adding a block?");
			input.focus();
		}
	}
	function initColPickers(){
		// Initialise Colour Pickers
		// For the time being repetitive because i can't get the loop counter [i] into the onchange function
		var bgColor = jQuery.parseJSON(lastSave).background;
		$('#canvasBGCol').colpick({
			colorScheme:'dark',
			layout:'hex',
			submit:0,
			color: bgColor,
			onChange:function(hsb,hex,rgb,el,bySetColor) {
				$(el).css('background-color','#'+hex);
				if(!bySetColor){
					canvas.backgroundColor='#'+hex;
					canvas.renderAll();
					isSaved=false;
				}
			}
		}).css('background-color', bgColor);
		$('#backgroundColor').colpick({
			colorScheme:'dark',
			layout:'hex',
			submit:0,
			onChange:function(hsb,hex,rgb,el,bySetColor) {
				$(el).css('background-color','#'+hex);
				if(!bySetColor){
					setActiveProp("backgroundColor", '#'+hex);
				}
			}
		});
		$('#textBackgroundColor').colpick({
			colorScheme:'dark',
			layout:'hex',
			submit:0,
			onChange:function(hsb,hex,rgb,el,bySetColor) {
				$(el).css('background-color','#'+hex);
				if(!bySetColor){
					setActiveStyle("textBackgroundColor", '#'+hex);
				}
			}
		});
		$('#textColor').colpick({
			colorScheme:'dark',
			layout:'hex',
			submit:0,
			onChange:function(hsb,hex,rgb,el,bySetColor) {
				$(el).css('background-color','#'+hex);
				if(!bySetColor){
					setActiveStyle("fill", '#'+hex);
				}
			}
		});
		$('#stroke').colpick({
			colorScheme:'dark',
			layout:'hex',
			submit:0,
			onChange:function(hsb,hex,rgb,el,bySetColor) {
				$(el).css('background-color','#'+hex);
				if(!bySetColor){
					setActiveStyle("stroke", '#'+hex);
				}
			}
		});
		$('#fillColor').colpick({
			colorScheme:'dark',
			layout:'hex',
			submit:0,
			onChange:function(hsb,hex,rgb,el,bySetColor) {
				$(el).css('background-color','#'+hex);
				if(!bySetColor){
					setActiveStyle("fill", '#'+hex);
				}
			}
		});
		$('#newtextcolor').colpick({
			colorScheme:'dark',
			layout:'hex',
			submit:0,
			color: '000000',
			onChange:function(hsb,hex,rgb,el,bySetColor) {
				$(el).css('background-color','#'+hex);
				fntcolor = '#'+hex;
			}
		}).css('background-color', '#000000');
		$('#newblkcol').colpick({
			colorScheme:'dark',
			layout:'hex',
			submit:0,
			color: 'ffffff',
			onChange:function(hsb,hex,rgb,el,bySetColor) {
				$(el).css('background-color','#'+hex);
				blkcolor = '#'+hex;
			}
		}).css('background-color', '#ffffff');
	}

	/************************ BOARD EDITOR CONTROLLERS *************************/
	function startIdleListener(){
		// Increase idle time every minute
		idleInterval = setInterval(timerIncrement, 60000);
		// Zero the idle timer on mouse or keyboard movement
    	$(this).mousemove(function (e) {
        	idleTime = 0;
    	});
    	$(this).keypress(function (e) {
			idleTime = 0;
		});
    }
    function timerIncrement() {
		if(++idleTime > 14) // 15 minutes
       		timedOut(true);
	}
	function timedOut(afk) {
		if(afk){
			// Auto-save changes
			$.ajax({
				url: 'saveBoard',
				data: {
					boardUser: "{{ currBoard.boardUser }}",
					boardID: {{ currBoard.boardID }},
					data: JSON.stringify(canvas)
				},
				type: "POST",
				async: false
			});
			isSaved = true;
			// Reset editor in NDB
			$.ajax({
				url: 'resetEditor',
				data: {
					user: "{{ currBoard.boardUser }}",
					boardID: {{ currBoard.boardID }}
				},
				type: "POST",
				async: false
			}).done(function( data ) { // unnecessary data?
				// document.getElementById("toolBoxButton").style.display = "block";
				// Remove functions -> alert -> reload
				document.getElementById("exitButton").style.display = "none";
				document.getElementById("myTab").style.display = "none";
				document.getElementById("myTabContent").style.display = "none";
				document.getElementById("boardButtons").style.display = "none";
				document.getElementById("editinglocked").style.display = "none";
				alert("You have been kicked out of edit mode, you AFK-er! \n(P.S. your work has been auto-saved)");
				location.reload(true); // not sure if we need the optional force-load-from-server
			});
		} else {
			$.ajax({
				url: 'resetEditor',
				data: {
					user: "{{ currBoard.boardUser }}",
					boardID: {{ currBoard.boardID }}
				},
				type: "POST",
				async: false
			});
		}
	}

	/************************ BOARD FUNCTIONS *************************/
	function loadCanvas(){
		canvas.loadFromJSON(
			lastSave,							// Input data: load from lastSave
			canvas.renderAll.bind(canvas),		// 'Callback'(optional): rerender canvas
			function(o,object){ 				// 'Reviver' (optional): re-set default settings on all objects
				setDefSettings(object);
			}
		);
		isSaved = true;
	}
	function saveCanvas(wAlert){
		$.ajax({
			url: 'saveBoard',
			data: {
				boardUser: "{{ currBoard.boardUser }}",
				boardID: {{ currBoard.boardID }},
				data: JSON.stringify(canvas)
			},
			type: "POST",
			async: false
		});
		lastSave = JSON.stringify(canvas);
		if(wAlert)
			alert("Successfully saved!");
		isSaved = true;
	}
	function revert(){
		var resp=confirm("You sure? All your unsaved work will be lost...");
		if(resp==true){
  			loadCanvas();
  			orig=null;
  		}
  	}
  	function clearCanvas(){
  		var resp=confirm("Are you sure? This will clear everything!");
  		if (resp){
  			canvas.clear();
  			isSaved = false;
  		}
  	}

  	/************************ NEW OBJECTS FUNCTIONS *************************/
  	function setDefSettings(curr){	// *** consider adding these features to toJSON(options)
		curr.set({
			borderColor: 'rgba(67,46,79,0.75)',
			cornerColor: 'rgba(58,174,175,0.85)',
			cornerSize: 9,
			transparentCorners: false,
			originX: "center",
			originY: "center",
		});
		if(curr.height>curr.width)
			curr.set({minScaleLimit: 10.0/curr.height});
		else
			curr.set({minScaleLimit: 10.0/curr.width});
	}
  	function addBlock(){
  		var rect = new fabric.Rect({
  			width: 10,
  			height: 10,
  			scaleX: 3,
  			scaleY: 3,
			fill: blkcolor,
		});
		setDefSettings(rect);		// Consider add(rect) to do setDef, .add(), center()/setCoords, setActive, isSaved
  		canvas.add(rect);
  		rect.center();
  		rect.setCoords();
  		canvas.setActiveObject(rect);
  		isSaved = false;
  	}
	function addText() {
		var input = document.getElementById("newtext");
		var text = input.value;
		if(text == null || text.trim() == ""){
			text = "Click to edit";
		}
		var newText = new fabric.IText(text);
		newText.set({fill: fntcolor});

		canvas.add(newText);
		setDefSettings(newText);
		newText.center();
		newText.setCoords();

		canvas.setActiveObject(newText);
		isSaved = false;
  	}
	function addPostIt(){
  		var bgcolor = blkcolor;
  		var txtcolor = fntcolor;
  		var input = document.getElementById("newtext");
  		var text = input.value;
		if(text == null || text.trim() == ""){
			text = "Click to edit";
		}
		var newText = new fabric.IText(text);
		newText.fontSize = 30;
		newText.backgroundColor = bgcolor;
		newText.fill = txtcolor;
		newText.paddingX = 10;
		newText.paddingY = 20;
		newText.scaleX = 0.6;
		newText.scaleY = 0.6;
		newText.lockUniScaling = true;
		newText.postit = true;
		newText.darkerShade = tinycolor.darken(bgcolor, 30).toHexString();
		canvas.add(newText);
		setDefSettings(newText);
		newText.center();
		newText.setCoords();
		canvas.setActiveObject(newText);
		isSaved = false;
  	}
  	// IMAGE FUNCTIONS
	function imageBox(e) {
		$("#imagebox").overlay().load();
	}
	function preloadImage() {
		var url = document.getElementById("imageurl").value;
		var image = document.getElementById("imageHolder");
		// image.crossOrigin = 'anonymous';
       	image.src = url;
       	$("#noPreview").hide();
       	$("#imageHolder").show();
       	$("img").error(function(){
    		$(this).hide();
    		$("#noPreview").show();
    	});
	}
	function addImage(){
		var url = document.getElementById("imageHolder").src;
		fabric.Image.fromURL(url, function(oImg){
			if(oImg.getHeight()>oImg.getWidth()){
				oImg.scale((canvas.getHeight()/oImg.getHeight())/2);
			}else{
				oImg.scale((canvas.getWidth()/oImg.getWidth())/2);
			}
			setDefSettings(oImg);
			canvas.add(oImg);
			oImg.center();
			oImg.setCoords();
			canvas.setActiveObject(oImg);
		}, {crossOrigin: 'anonymous'});
		$("#imagebox").overlay().close();
	}

	/************************ OBJECT MODIFIERS *************************/
  	function cloneActive(){
  		var curr = canvas.getActiveGroup() || canvas.getActiveObject();
  		var items = curr._objects;
  		// If curr contains multiple objects
  		if(items) {
  			var newItems = [];
  			curr.forEachObject( function(o) {
  				newItems.push(o.clone());
  			});
  			var clone = new fabric.Group(newItems);
  			canvas.add(clone);
  			setDefSettings(clone);
  			clone.center();
  			clone.setCoords();
  			canvas.discardActiveObject();
  			canvas.discardActiveGroup();
  			canvas.setActiveObject(clone);
  		}
  		//  If curr is a single object
  		else if(curr) {
  			var clone = fabric.util.object.clone(curr);
  			canvas.add(clone);
  			clone.center();
  			clone.setCoords();
  			canvas.discardActiveObject();
  			canvas.setActiveObject(clone);
  		}
  		// If no relevant object selected (remove this if isSaved is removed)
  		else {
  			return;
  		}
  		console.log(canvas);
  		isSaved = false;
  	}
  	function delActive() {
  		var currGrp = canvas.getActiveGroup();
  		var curr = canvas.getActiveObject();
		if(currGrp){
			currGrp.forEachObject(function(o){ canvas.remove(o) });
			canvas.discardActiveGroup().renderAll();
		} else if(curr){
			canvas.remove(canvas.getActiveObject());
		}
		resetInfoWin();
		isSaved = false;
  	}
  	function groupActive() {
  		var currGrp = canvas.getActiveGroup();
  		if(!currGrp) return;
  		// Does not support group-ception
		var items = currGrp._objects;
		for(var i = 0; i < items.length; i++) {
			if(items[i]._objects!=null){
				alert("Sorry, but we can't do group-ception! \n(i.e. no groups within groups allowed)");
				return;
			}
		}
  		// Save current location
  		var coords = {
  			left: currGrp.left,
  			top: currGrp.top,
  			angle: currGrp.angle,
  		};
  		console.log(canvas);
  		// Save items to add/remove in two arrays
  		var grpItems = [];		// Clones of items
  		var toRemove = [];		// Actual items
  		// Find and save items in order of layer position
  		// (Largest index = top object in canvas | Currently an n*m algo; I don't see a workaround.)
  		for(var i=0; i<canvas._objects.length; i++){
  			var temp = canvas.item(i);
  			console.log(temp);
  			if(currGrp.contains(temp)){
  				console.log(fabric.util.object.clone(temp));
  				grpItems.push(fabric.util.object.clone(temp));		// Last object in grpItems is top item
  				console.log(grpItems);
  				toRemove.push(temp);				// Save the items to remove (no concurrent removal)
  			}
  		}
  		// Remove current items
  		for(var i=0; i<toRemove.length;i++){
  			canvas.remove(toRemove[i]);
  		}
		canvas.discardActiveGroup();
		// Add group onto canvas
		console.log(grpItems);
		var newGrp = new fabric.Group(grpItems);
		canvas.add(newGrp);
		setDefSettings(newGrp);
		newGrp.set(coords);
		newGrp.setCoords();
		canvas.setActiveObject(newGrp);
		isSaved = false;

		console.log(newGrp);
  	}
  	function breakActiveGrp() {
  		var curr = canvas.getActiveObject();
  		if(!curr || curr._objects==null) return;
		var items = curr._objects;
		curr._restoreObjectsState();
		canvas.remove(curr);
		for(var i = 0; i < items.length; i++) {
			canvas.add(items[i]);
			setDefSettings(items[i]);
			items[i].setCoords();
		}
  		canvas.discardActiveObject();
  		isSaved = false;
  	}
	// TEXT FUNCTIONS
	function textFont(){
		var curr = canvas.getActiveObject();
		if(!curr) return;
		var txt = document.getElementById("infoFont").value;
	}
	function setActiveStyle(styleName, value, object) {
		object = object || canvas.getActiveObject();
		if (!object) return;

		if (object.setSelectionStyles && object.isEditing) {
			var style = { };
			style[styleName] = value;
			object.setSelectionStyles(style);
			object.setCoords();
			alert(style);
		} else {
			object[styleName] = value;
			if (styleName == "strokeWidth") {
				if (value == 0)
					object["stroke"] = null;
				else if (object["stroke"] == null)
					object["stroke"] = "#FFFFFF";
			}
		}

		object.setCoords();
		canvas.renderAll();
	}
	function setActiveProp(name, value) {
		var object = canvas.getActiveObject();
		if (!object) return;

		if (name == "backgroundColor") {
			setActiveProp("darkerShade", tinycolor.darken(value, 20).toHexString());
		}
		object.set(name, value).setCoords();
		canvas.renderAll();
	}
	function getActiveStyle(styleName, object) {
		object = object || canvas.getActiveObject();
		if (!object) return '';

		return (object.getSelectionStyles && object.isEditing)
		? (object.getSelectionStyles()[styleName] || '')
		: (object[styleName] || '');
	}
	function isUnderline() {
		return getActiveStyle('textDecoration').indexOf('underline') > -1;
	}
	function toggleUnderline() {
		var value = isUnderline()
		? getActiveStyle('textDecoration').replace('underline', '')
		: (getActiveStyle('textDecoration') + ' underline');

		setActiveStyle('textDecoration', value);
	}
	function isLinethrough() {
		return getActiveStyle('textDecoration').indexOf('line-through') > -1;
	}
	function toggleLinethrough() {
		var value = isLinethrough()
		? getActiveStyle('textDecoration').replace('line-through', '')
		: (getActiveStyle('textDecoration') + ' line-through');

		setActiveStyle('textDecoration', value);
	}
	function isOverline() {
		return getActiveStyle('textDecoration').indexOf('overline') > -1;
	}
	function toggleOverline() {
		var value = isOverline()
		? getActiveStyle('textDecoration').replace('overline', '')
		: (getActiveStyle('textDecoration') + ' overline');

		setActiveStyle('textDecoration', value);
	}

	/************************ CANVAS MODIFIERS *************************/
	$(function () {
		$("#selectableBG").selectable({
			stop: function() {
				$(".ui-selected", this).each(function() {
					if ($("#selectableBG li").index(this) > -1) {
						bgselected = $("#selectableBG li").index(this) + 1;
					}
				});
			}
		});
	});
	function bgimgBox(e) {
		$("#bgimgbox").overlay().load();
	}
	function bgpreloadImage() {
		var url = document.getElementById("bgimageurl").value;
		var image = document.getElementById("bgimageHolder");
       	$("#bgimageHolder").show();
       	image.src = url;
       	$("#bgnoPreview").hide();
       	$("img").error(function(){
       		image.src = "images/bg6.jpg";
    		$("#bgnoPreview").show();
    	});
	}
    function changeBGImg() {
    	if (bgselected < 6) {
	    	canvas.setBackgroundImage('../images/bg' + bgselected + '.jpg', canvas.renderAll.bind(canvas));
    	} else {
    		imagesrc = document.getElementById("bgimageHolder").src;
    		url = document.getElementById("bgimageurl").value;
    		if (url != "" && imagesrc != "http://pinnerspace.appspot.com/images/bg6.jpg" && imagesrc != "http://localhost:10080/images/bg6.jpg") {
    			canvas.setBackgroundImage(imagesrc, canvas.renderAll.bind(canvas),{
    				width: canvas.width,
    				height: canvas.height
    			});
    		} else {
    			canvas.backgroundImage = false;
    			canvas.renderAll();
    		}
    	}
    	isSaved = false;
    }

  	/************************ TAB-RELATED *************************/
	function switchTab(){
		$("#myTab > .active").removeClass("active");
		$("#myTabContent > .active").removeClass("active");
		$("#currObjTab").addClass("active");
		$("#modifycurrent").addClass("in active");
	}
	function updateInfoWin(curr){
		document.getElementById("infoX").value = toTwoDP(curr.getLeft());
		document.getElementById("infoY").value = toTwoDP(curr.getTop());
		document.getElementById("infoW").value = toTwoDP(curr.getWidth());
		document.getElementById("infoH").value = toTwoDP(curr.getHeight());
		document.getElementById("infoAng").value = toTwoDP(curr.getAngle() % 360);
		// Change fields for infowin
		var activeObj = canvas.getActiveObject();
		var activeGrp = canvas.getActiveGroup();
		if(activeGrp){
			document.getElementById("toolBox2").style.display = "block";
			document.getElementById("toolBox1").style.display = "none";
			document.getElementById("infotablep").style.display = "table";
			document.getElementById("infotable1a").style.display = "none";
			document.getElementById("itext-controls").style.display = "none";
		}else if(activeObj){
			document.getElementById("toolBox1").style.display = "block";
			document.getElementById("toolBox2").style.display = "none";
			document.getElementById("infotablep").style.display = "table";
			if(activeObj._objects != null){
				document.getElementById("breakgrpbtn").style.display = "inline-block";
				document.getElementById("infoFill").style.display = "none";
				document.getElementById("infoFillB").style.display = "none";
			}else{
				document.getElementById("breakgrpbtn").style.display = "none";
				// Note: this works overall since infotable is controlled by later commands
				document.getElementById("infoFill").style.display = "table-cell";
				document.getElementById("infoFillB").style.display = "table-cell";
			}
			if(activeObj.type=='i-text'){
				activeObj.lockUniScaling = true;
				document.getElementById("fontSize").value = activeObj.fontSize;
				document.getElementById("strokeWidth").value = activeObj.strokeWidth;
				document.getElementById("infotable1a").style.display = "none";
				document.getElementById("itext-controls").style.display = "block";
				if(activeObj.postit){
					document.getElementById("changePostitColor").style.display = "inline-block";
					$('#backgroundColor').colpickSetColor(activeObj.get("backgroundColor"),true);
					if(activeObj.getFill())
						$('#textColor').colpickSetColor(activeObj.getFill(),true);
					else
						$('#textBackgroundColor').colpickSetColor('#ffffff',true);
					if(activeObj.getTextBackgroundColor())
						$('#textBackgroundColor').colpickSetColor(activeObj.getTextBackgroundColor(),true);
					else
						$('#textBackgroundColor').colpickSetColor('#ffffff',true);
					if(activeObj.getStroke())
						$('#stroke').colpickSetColor(activeObj.getStroke(),true);
					else
						$('#stroke').colpickSetColor('#ffffff',true);
				}else{
					if(activeObj.getStroke()) $('#stroke').colpickSetColor(activeObj.getStroke(), true);
					else $('#stroke').colpickSetColor('#ffffff', true)
					document.getElementById("changePostitColor").style.display = "none";
				}
			}else{
				document.getElementById("infotable1a").style.display = "table-row";
				document.getElementById("itext-controls").style.display = "none";
				$('#fillColor').colpickSetColor(activeObj.getFill(),true);
			}
		}
	}
	function toTwoDP(num){
		return Math.round(num*100)/100;
	}
	function resetInfoWin(){
		document.getElementById("infoX").value="";
		document.getElementById("infoY").value="";
		document.getElementById("infoW").value="";
		document.getElementById("infoH").value="";
		document.getElementById("infoAng").value="";
		// Deselect effects
		atLimit=null;
		orig=null;
		document.getElementById("toolBox1").style.display = "none";
		document.getElementById("toolBox2").style.display = "none";
		document.getElementById("infotablep").style.display = "none";
		document.getElementById("itext-controls").style.display = "none";
	}
	function updateFromWin(box){
		var curr = canvas.getActiveObject();
		if(!curr) return;
		var boxVal = parseInt(box.value);
		if(boxVal!=0 && !boxVal) return;
		switch(box.id){
			case "infoX":
				curr.set({left: boxVal});
				break;
			case "infoY":
				curr.set({top: boxVal});
				break;
			case "infoW":
				curr.set({scaleX: boxVal/curr.width});
				break;
			case "infoH":
				curr.set({scaleY: boxVal/curr.height});		// if(Math.abs(boxVal)<=800)
				break;
			case "infoAng":
				curr.set({angle: boxVal%360});
				break;
		}
		curr.setCoords();
		// Check if OOB:
		// (1) checkPos will push obj back in
		// (2) checkScaleAngle will reset obj if still OOB
		if(checkPos(curr) && checkScaleAngle(curr))
			alert("That's an invalid value!\nPlease try again.");

		// After all changes are done
		canvas.renderAll();
		atLimit = {
			top: curr.getTop(),
			left: curr.getLeft(),
			scaleX: curr.getScaleX(),
			scaleY: curr.getScaleY(),
			angle: curr.getAngle(),
		};
		orig = fabric.util.object.clone(curr);
		isSaved = false;
	}

	/************************ BOARD BOUNDARIES *************************/
	// Save original state for clone (on selection)
	// Triggers switchTab(), updates InfoWindow
	function objSelected(e) {
  		orig = fabric.util.object.clone(e.target);
  		atLimit = {
			top: orig.getTop(),
			left: orig.getLeft(),
			scaleX: orig.getScaleX(),
			scaleY: orig.getScaleY(),
			angle: orig.getAngle(),
		};
  		switchTab();
  		updateInfoWin(orig);
  	}

  	// Save last acceptable state (on scale/rotate)
	function setLimit(e){
		var curr=e.target;
		curr.setCoords();
		// if not out of bounds, save state
		// (the interval is not very fast, so this method is not so precise if you move fast)
		if(!isOOB(curr)){
			atLimit = {
				top: curr.getTop(),
				left: curr.getLeft(),
				scaleX: curr.getScaleX(),
				scaleY: curr.getScaleY(),
				angle: curr.getAngle(),
			};
		}
	}
	// Check if out of bounds (on modified)
	function checkOOB(e){
		var curr = e.target;
		if(!curr) return;
		// if scale/angle has been modified, checkScaleAngle for OOB
		if(((orig.getScaleX() != curr.getScaleX()) || (orig.getScaleY() != curr.getScaleY())) || (orig.getAngle() != curr.getAngle()))
			checkScaleAngle(curr);
		// otherwise check position
		else
			checkPos(curr);
		// save new state
		orig = fabric.util.object.clone(curr);
		atLimit = {
			top: curr.getTop(),
			left: curr.getLeft(),
			scaleX: curr.getScaleX(),
			scaleY: curr.getScaleY(),
			angle: curr.getAngle(),
		};
		// console.log("After checkOOB: " + JSON.stringify(atLimit));
		updateInfoWin(orig);
		setDefSettings(curr);
  		curr.setCoords();
		isSaved = false;
	}
	// Returns object holding whether curr is OOB in the four canvas edges
	function getOOBObj(curr){
		var bounds = curr.getBoundingRect(),
			maxWidth = canvas.getWidth(),
			maxHeight = canvas.getHeight();
		// Additional 1px accounts for bounding rect.
		// Without this checkPos will always trigger, even after correction
		var outOf = {
			top: bounds.top < -1,
			left: bounds.left < -1,
			bottom: bounds.top+bounds.height > maxHeight+1,
			right: bounds.left+bounds.width > maxWidth+1,
		};
		return outOf;
	}
	// Returns boolean true if object is out of bounds in any edge(s)
	function isOOB(curr){
		var outOf = getOOBObj(curr);
		return (outOf.right || outOf.left) || (outOf.bottom || outOf.top);
	}
	// If object is out of bounds reset to last atLimit state
	function checkScaleAngle(curr){
		// console.log("InsideCheckAngle: " + JSON.stringify(atLimit));
		if(isOOB(curr)){
			curr.set(atLimit);
			curr.setCoords();
			return true;
			// console.log("New curr: " + JSON.stringify(curr));
		}
		return false;
	}
	// If object is out of bounds push it back in (requires object originX/Y to be "center")
	function checkPos(curr){
		var updateCoords = false,
			bounds = curr.getBoundingRect(),
			maxWidth = canvas.getWidth(),
			maxHeight = canvas.getHeight();
		var outOf = getOOBObj(curr);

		if(outOf.right){
			updateCoords = true;
			curr.set({left: maxWidth-bounds.width/2});
		}
		if(outOf.bottom){
			updateCoords = true;
			curr.set({top: maxHeight-bounds.height/2});
		}
		if(outOf.left){
			updateCoords = true;
			curr.set({left: bounds.width/2});
		}
		if(outOf.top){
			updateCoords = true;
			curr.set({top: bounds.height/2});
		}

		// Implement new coordinates
		if(updateCoords){
			curr.setCoords();
			return true;
		}
		return false;
	}

	</script>
</body>
</html>